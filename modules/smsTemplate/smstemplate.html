<div class="table-responsive" >
    <table cellspacing="0" width="100%" class="table" style="overflow: hidden">
        <tr data-width="100%" style="margin: 0;padding: 0">
            <td width="20%">
                <ul style="padding:0;">
                    <li style="list-style: none">
                        <a id="button-smsgroup-create" href="javascript:void(0);">
                            <i class="fa fa-plus"></i>新增短信模板分类</a></li>
                    <input id="hiddengroupid" type="hidden">
                </ul>
                <div class="panel-box">
                    <table id="table-smsgroup-sheet" class="table table-hover"  cellspacing="0" width="100%">
                        <thead>
                        <tr>
                            <th></th>
                            <th>
                                <button id="button-sms" style="background: none;border: none;">
                                    短信分类</button>
                                <button id="button-smsgroup-update" style="background: none;border: none;margin-left: 5px;color: #2a7dd0;font-weight: lighter">
                                    修改分类</button>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr role="row">
                            <td class=" select-checkbox"></td>
                            <td>全部分类</td>
                        </tr>
                        </tbody>
                    </table>
                    <p><span style="color: red"> * </span>点击短信模板分类下任意一行可根据该行分类对短信模板进行筛选</p>
                    <p><span style="color: red"> * </span>点击短信分类展示全部短信模板</p>
                </div>
            </td>
            <td width="80%">
                <ul style="padding: 0">
                <li style="list-style: none;display: inline-block"><a id="button-template-create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增短信模板</a></li>
                <li style="list-style: none;display: inline-block"><a id="button-template-update" href="javascript:void(0);"><i class="fa fa-pencil-square-o"></i>修改短信模板</a></li>
                </ul>
                <div class="panel-box">
                    <table id="table-template-sheet" class="table table-hover"  cellspacing="0" width="100%">
                        <thead>
                        <tr>
                            <th></th>
                            <th>短信模板
                                <input id="filter_smsgroupname" style="width:150px;margin-left: 20px;font-weight: lighter"  type="text" placeholder="短信主题" >
                                <button type="button" id="filter-sms-qrybtn" style='padding:2px 10px;'  class="btn btn-primary" >&nbsp;&nbsp;&nbsp;查询&nbsp;&nbsp;&nbsp;</button>
                            </th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</div>
<div id="dialog-smsgroup-update" class="modal fade" tabindex="-1"  data-width="500" data-height="250" data-backdrop="static" data-keyboard="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-groupment-update" class="modal-title">添加短信模板分类</h4>
    </div>
    <div class="modal-body">
        <form id="form-smsgroupment-update" class="m-t form-horizontal" role="form">
            <input name="marketsmsgroupid" id = "smsgroupid" type="hidden">
            <input name="createtime" type="hidden" id="createtime">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>分类名称</label>
                <div class="col-lg-9"><input name="marketsmsgroupname" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>状态</label>
                <div class="col-lg-9">
                    <select name="status" class="form-control">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="40">冻结</option>
                        <option value="50">隐藏</option>
                        <option value="60">关闭</option>
                        <option value="70">过期</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <br>
            <button id="smsGroup-create" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>
<div id="dialog-template-update" class="modal fade" tabindex="-1"  data-backdrop="static" data-keyboard="false" data-width="600" data-height="550" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-sms-update" class="modal-title">新增短信模板</h4>
    </div>
    <div class="modal-body">
        <form id="form-template-update" class="m-t form-horizontal" enctype="multipart/form-data" role="form">
                <input name="marketsmstemplateid" id="templateid" type="hidden">
                <input name="createtime" type="hidden" id="templatetime">
                <div class="form-group">
                    <label class="col-lg-3 control-label" style="text-align: left">短信分类</label>
                    <div class="col-lg-12">
                       <select id="smsgroupid_select" class="form-control" name="marketsmsgroupid"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-3 control-label" style="text-align: left">短信标题</label>
                    <div class="col-lg-12">
                        <input class="form-control" name="marketsmstemplatetitle">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-lg-3 control-label" style="text-align: left">短信内容</label>
                    <div class="col-lg-12">
                        <textarea class="form-control" id="content" rows="8" name="content"></textarea>
                    </div>
                </div>
            <div class="form-group">
                <label class="col-lg-3 control-label" style="text-align: left">短信状态</label>
                <div class="col-lg-12">
                    <select class="form-control" name="status">
                            <option value="10">正常</option>
                            <option value="20">下线</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-lg-5 col-lg-offset-3">
                    <button id="formbtn-template-update" type="button" class="btn btn-theme btn-lg btn-block " style="width: 45%;margin-left:27.5%;">提 交</button><br>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
    {
        //获取短信模板分类列表
        $.ajax({
            url:"/pipes/merchsms/querysmsgroup",
            data:{"bean":"{}"},
            type:"POST",
            dataType:"JSON",
            success:function(res){
                if(res&&res.retcode>0){
                    alert(res.retinfo);
                }else{
                    res = res.rows;
                    var _html="";
                    if(res.length==0){
                        _html = "<option>请先增加短信模板分类</option>"
                    }else{
                        for(var i=0;i<res.length;i++){
                            _html+= "<option value='"+res[i].marketsmsgroupid+"'>"+res[i].marketsmsgroupname+"</option>"
                        }
                    }
                    $("#smsgroupid_select").html(_html);
                }
            },
            error:function(err){
                console.log(err)
            }
        });
        if (system_memberinfo && system_memberinfo.memberid) {
            //短信模板列表
            var mtable = $('#table-template-sheet').dataTable({
                ajax: {
                    url: "/pipes/merchsms/querysmstemplate",
                    data: function (f) {
                        f.bean = JSON.stringify({
                            "marketsmstemplatetitle":$("#filter_smsgroupname").val().trim(),
                            "marketsmsgroupid":$("#hiddengroupid").val()
                        });
                        f.sort = 'createtime';
                        f.order = 'DESC';
                        f.length = '5';
                    }
                },
                "aLengthMenu": [[5, 25, 50, -1], ["5条", "25条", "50条", "All"]],
                columnDefs: [
                    {
                        className: 'select-checkbox',
                        targets: 0
                    }
                ],
                columns: [
                    {"data": "", render: $.defrender},
                    {"data": "marketsmstemplatetitle", render:function(value,type,full){
                        function status(status){
                            if(status==10) return "正常";
                            if(status==20) return "下线";
                        }
                        if(value ==undefined){
                            value = '暂无主题'
                        }
                        return '<h4 style="margin: 0;padding: 5px">主题:&nbsp;'+value+'<span style="float: right;font-weight: lighter">短信状态:'+status(full.status)+'</span></h4>'+
                                '<h4  style="margin: 0;padding: 5px">内容:</h4>'+
                                '<p style="text-indent: 2em;word-wrap:break-word;word-break:break-all;">'+full.content+'</p>'+
                                '<p style="padding: 5px"><span style="display: inline-block;float: right">'+Date.DateFormatter(full.createtime)+'</span></p>';
                    }}
                ]
            });
            //短信模板分类列表
            var mtable2 = $('#table-smsgroup-sheet').dataTable({
                pagingType:"simple",
                ajax: {
                    url: "/pipes/merchsms/querysmsgroup",
                    dataSrc:function (data) {
                        return data.rows;
                    },
                    data: function (f) {
                        f.bean = JSON.stringify({
                        });
                        f.sort = 'createtime';
                        f.order = 'DESC';
                        f.length = '10';
                    }
                },
                columnDefs: [
                    {
                        className: 'select-checkbox',
                        targets: 0
                    }
                ],
                columns: [
                    {"data": "", render: $.defrender},
                    {"data": "marketsmsgroupname",render:$.defrender}
                ]
            });
            //根据短信模板名称关键字查询短信模板
            $("#filter-sms-qrybtn").click(function(){
                mtable.api(true).draw(false);
                $('#table-storeinfo-sheet').dataTable().fnPageChange(0);
            });
            //点击新增短信模板分类
            $("#button-smsgroup-create").bind("click",function(){
                    $("#form-smsgroupment-update").form('reset');
                    $("#dialog-smsgroup-update").modal('show');
                    $("#smsgroupid").val("");
                    $("#createtime").val("");
            });
            //点击修改短信模板分类
            $("#button-smsgroup-update").bind("click",function(){
                var data = mtable2.api(true).row({selected: true}).data();
                if (!data || !data.marketsmsgroupid) {
                    alert("请选择一条记录！");
                    return;
                }
                $("#form-smsgroupment-update").form('reset');
                $("#form-smsgroupment-update").form("load",data);
                $("#dialog-smsgroup-update").modal('show');
            });
            //--------------新增/修改短信模板分类提交--------------------------
            $("#smsGroup-create").bind("click",function(){
                $(this).attr("disabled",true);
                $.ajax({
                    url:"/pipes/merchsms/querysmsgroup",
                    data:{"bean":"{}"},
                    type:"POST",
                    dataType:"JSON",
                    success:function(res){
                        if(res&&res.retcode>0){
                            $("#smsGroup-create").removeAttr("disabled");
                            alert(res.retinfo);
                        }else{
                            var i = res.rows.length-1;
                            var groupidval="";
                            if(i>=0){
                                var arr=res.rows[i].marketsmsgroupid.split(".");
                                var groupid3 = Number(arr[1])+1;
                                groupidval=arr[0]+"."+groupid3;
                            }else{
                                groupidval="c.101";
                            }
                            var form=$("#form-smsgroupment-update");
                            var json = form.serializeJson();
                            updategoodsgroup(groupidval,json);
                        }
                    },
                    error:function(err){
                        console.log(err)
                    }
                });
            });
            function updategoodsgroup(data1,json){
                if(json.marketsmsgroupid==""){
                    json.marketsmsgroupid=data1;
                }
                var data = "";
                if(json.createtime){
                    data={
                        "bean":$.objectToString(json),
                        "cols":$.objectToString(["marketsmsgroupname"])
                    };
                }else{
                    data={
                        "bean":$.objectToString(json)
                    };
                }
                $.ajax({
                    url:"/pipes/merchsms/updatesmsgroup",
                    data:data,
                    dataType:"JSON",
                    type:"POST",
                    success:function(data){
                        $("#smsGroup-create").removeAttr("disabled");
                        if(data.retcode===0){
                            $("#dialog-smsgroup-update").modal("hide");
                            mtable2.api(true).draw(false);
                            $.ajax({
                                url:"/pipes/merchsms/querysmsgroup",
                                data:{"bean":"{}"},
                                type:"POST",
                                dataType:"JSON",
                                success:function(res){
                                    var res = res.rows;
                                    var _html="";
                                    for(var i=0;i<res.length;i++){
                                        _html+= "<option value='"+res[i].marketsmsgroupid+"'>"+res[i].marketsmsgroupname+"</option>";
                                    }
                                    $("#smsgroupid_select").html(_html);
                                },
                                error:function(err){
                                    alert("请求失败");
                                    console.log(err);
                                }
                            });
                        }else{
                            alert(data.retinfo);
                        }
                    },
                    error:function(error){
                        $("#smsGroup-create").removeAttr("disabled");
                        console.log(error);
                        alert("请求失败");
                    }
                });
            }
            //点击新增短信模板
            $("#button-template-create").bind("click", function () {
                $("#form-template-update").form('reset');
                $("#dtitle-sms-update").text('新增短信模板');
                $("#templateid").val("");
                $("#templatetime").val("");
                $('#dialog-template-update').modal('show');
            });
            //--------------点击修改短信模板------------------------------
            $("#button-template-update").click(function(){
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.marketsmsgroupid) {
                    alert("请选择一条记录！");
                    return;
                }
                $("#dtitle-sms-update").text('修改短信模板');
                $("#form-template-update").form('load',data);
                $('#dialog-template-update').modal('show');
             
            });
            //--------------新增&&修改短信模板提交------------------------------
            $("#formbtn-template-update").click(function () {
                $(this).attr("disabled");
                var form =$("#form-template-update");
                var json = form.serializeJson();
                //-----去json数据中的空格-----------------
                var json1= {};
                $.each(json,function(key,value){
                    value = (value + "").replace(/\s/g,'');
                    json1[key] = value;
                });
                json = json1;
                //---------------------------------
                var data = "";
                if(json.createtime){
                    var cols = [];
                    for(var key in json){
                        if(key=="marketsmstemplateid"||key=="createtime"){
                            continue;
                        }
                        cols.push(key);
                    }
                    data = {
                        "bean":$.objectToString(json),
                        "cols":$.objectToString(cols)
                    }
                }else{
                    data = {
                        "bean":$.objectToString(json)
                    }
                }
                $.ajax({
                    url:"/pipes/merchsms/updatesmstemplate",
                    data:data,
                    dataType:"JSON",
                    type:"POST",
                    success:function(data){
                        $("#formbtn-template-update").removeAttr("disabled");
                        if(data&&data.retcode>0){
                            alert(data.retinfo);
                        }else{
                            $("#dialog-template-update").modal('hide');
                            mtable.api(true).draw(false);
                        }
                    },
                    error:function(error){
                        $("#formbtn-template-update").removeAttr("disabled");
                        console.log(error);
                    }
                })
            });
            //点击商品分类进行商品的筛选
            $("#table-smsgroup-sheet_wrapper").on('click','td',function(){
                var data = mtable2.api(true).row({selected: true}).data();
                if(data&&data.marketsmsgroupid){
                    $("#hiddengroupid").val(data.marketsmsgroupid);
                    mtable.api(true).draw(false)
                }
            });
            $("#button-sms").click(function(){
                $("#hiddengroupid").val("");
                mtable.api(true).draw(false);
            });
            //回车键执行搜索功能
            $('#filter_smsgroupname').keydown(function(e){
                if(e.keyCode==13){
                    $('#filter-sms-qrybtn').trigger('click');
                }
            });
        }
    }
</script>