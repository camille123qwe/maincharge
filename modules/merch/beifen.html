
<div class="form-group">
    <div class="col-lg-5 col-md-5 col-sm-5">
        <div>
            &nbsp;[ <a id="addParent" href="#" title="新增功能模块" onclick="return false;">新增功能模块</a> ]
            &nbsp;&nbsp;&nbsp;&nbsp;[ <a id="addLeaf" href="#" title="新增功能操作" onclick="return false;">新增功能操作</a> ]
            &nbsp;&nbsp;&nbsp;&nbsp;[ <a id="edit" href="#" title="编辑名称" onclick="return false;">编辑名称</a> ]<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;[ <a id="remove" href="#" title="删除节点" onclick="return false;">删除节点</a> ]
        </div>
        <ul id="treeDemo"></ul>
        <div id="rMenu">
            <a href="javascript:void(0)" class="list-group-item" onclick="expand()">展开下一级</a>
            <a href="javascript:void(0)" class="list-group-item" onclick="expandSon()">展开所有子节点</a>
            <a href="javascript:void(0)" class="list-group-item" onclick="collapse()">折叠子节点</a>
            <a href="javascript:void(0)" class="list-group-item" onclick="expandAll()">全部展开</a>
            <a href="javascript:void(0)" class="list-group-item" onclick="collapseAll()">全部折叠</a>
        </div>
    </div>
    <div class="col-lg-7 col-md-7 col-sm-7">
        <div class="page-title">
            <a id="button-merchUser-create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增管理员</a>
            <a id="button-merchUser-update" href="javascript:void(0);"><i class="fa fa-pencil-square-o"></i>修改管理员</a>
        </div>
        <div class="panel-box">
            <div class="page-title">
                <form class="filter-search" onsubmit="return false">
                    <div style="display: inline-block;margin: 0 10px 0 0;">
                        <label >商户名称：</label>
                        <input id="hidden_filter_merchid" type="hidden">
                        <input id="filter_merchid" style="width:150px;position: relative">
                        <div class="table-responsive" id="filter_merchid_table">
                            <table class="table table-hover">
                            </table>
                        </div>
                    </div>
                    <button style="width: 120px;" id="showall">显示全部</button>
                    <div style="display: inline-block;margin: 0 10px 0 0;">
                        <label >员工昵称：</label>
                        <input id="filter_merchuser" style="width:150px;position: relative">
                    </div>
                    <label>手机号码:</label><input placeholder="手机号码" id="filter_mobile">
                    <div style="display: inline-block;margin: 0 50px 0 0;">
                        <label >状态</label>
                        <select name="status" id="filter_storeinfo_status" style="width:150px;">
                            <option value="">全部</option>
                            <option value="10">正常</option>
                            <option value="20">待审批</option>
                            <option value="80">删除</option>
                        </select>
                    </div>
                    <i id="filter-merchUser-qrybtn" class="fa fa-search" style="position: static;"></i>
                </form>
            </div>
            <div class="table-responsive">
                <table id="table-merchUser-sheet" class="table table-hover" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th></th>
                        <th>门店名称</th>
                        <th>用户类型</th>
                        <th>员工昵称</th>
                        <th>员工账号</th>
                        <th>状态</th>
                        <th>手机号码</th>
                        <th>密码</th>
                        <!--  <th>备注说明</th>-->
                        <th>创建时间</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="dialog-function-update" class="modal fade" tabindex="-1" data-width="600" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" id="recordclose">×</button>
        <h4 id="dtitle-merchUser-update" class="modal-title">新增模块</h4>
    </div>
    <div class="modal-body">
        <form id="form-function-update" class="m-t form-horizontal" role="form">
            <input  name="createtime" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="status">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>模块名称</label>
                <div class="col-lg-9"><input name="modulename" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="platform">
                        <option value="B2B">商家版</option>
                        <option value="B2C">顾客版</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>icon图标地址</label>
                <div class="col-lg-9"><input name="icon" class="form-control"></div>
            </div>
            <button id="formbtn-function-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>

<div id="dialog-operation-update" class="modal fade" tabindex="-1" data-width="600" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-operation-update" class="modal-title">新增功能操作</h4>
    </div>
    <div class="modal-body">
        <form id="form-operation-update" class="m-t form-horizontal" role="form">
            <input  name="createtime" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="status">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>所属模块</label>
                <div class="col-lg-9">
                    <input name="moduleid" type="hidden" value="4">
                    <input value="测试" class="form-control" disabled>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>操作名称</label>
                <div class="col-lg-9"><input name="modulename" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="platform">
                        <option value="B2B">商家版</option>
                        <option value="B2C">顾客版</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>icon图标地址</label>
                <div class="col-lg-9"><input name="icon" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>访问url</label>
                <div class="col-lg-9"><input name="url" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>功能描述</label>
                <div class="col-lg-9"><input name="description" class="form-control"></div>
            </div>
            <button id="formbtn-operation-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>

<script>
    {
        $(function(){
            if(system_memberinfo.type==system_adminpid){
                $("#button-merchUser-update").after(' <a id="button-user-reset" href="javascript:void(0);">' +
                        '<i class="fa fa-pencil"></i>密码重置</a>')
            }
            //-----------Ztree 功能模块管理---------------
            var zTreeObj;
            // zTree 的参数配置，深入使用请参考 API 文档（setting 配置详解）
            var setting = {
                view:{
                    dblClickExpand:false,
                    selectedMulti: false

                },
                edit: {
                    enable: true,
                    showRemoveBtn: false,
                    showRenameBtn: false
                },
                data: {
                    keep: {
                        parent:true,
                        leaf:true
                    },
                    simpleData: {
                        enable: true,
                        pidKey:"b2bmoduleinfoid",
                        idKey:"id"
                    },
                    key:{
                        name:'modulename'
                    }
                },
                callback:{
                    onClick: onClick,
                    onRightClick: zTreeOnRightClick,
                    beforeDrag: beforeDrag,
                    beforeRemove: beforeRemove,
                    beforeRename: beforeRename,
                    onRemove: onRemove
                }
            };
            function onClick(e,treeId, treeNode) {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                zTree.expandNode(treeNode);
                console.log(treeNode.b2bmoduleinfoid);
            }

            function zTreeOnRightClick(event,treeId,treeNode){
                console.log(treeNode);
                console.log(event);
                showRMenu("root", event.clientX, event.clientY);
//                if (!treeNode && event.target.tagName.toLowerCase() != "button" && $(event.target).parents("a").length == 0) {
//                    showRMenu("root", event.clientX, event.clientY);
//                } else if (treeNode && !treeNode.noR) {
//                    showRMenu("node", event.clientX, event.clientY);
//                }
            }
            var log, className = "dark";
            function beforeDrag(treeId, treeNodes) {
                return false;
            }
            function beforeRemove(treeId, treeNode) {
                className = (className === "dark" ? "":"dark");
                showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
                return confirm("确认删除 节点 -- " + treeNode.name + " 吗？");
            }
            function onRemove(e, treeId, treeNode) {
                showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
            }
            function beforeRename(treeId, treeNode, newName) {
                if (newName.length == 0) {
                    alert("节点名称不能为空.");
                    var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                    setTimeout(function(){zTree.editName(treeNode)}, 10);
                    return false;
                }
                return true;
            }
            function showLog(str) {
                if (!log) log = $("#log");
                log.append("<li class='"+className+"'>"+str+"</li>");
                if(log.children("li").length > 8) {
                    log.get(0).removeChild(log.children("li")[0]);
                }
            }
            function getTime() {
                var now= new Date(),
                        h=now.getHours(),
                        m=now.getMinutes(),
                        s=now.getSeconds(),
                        ms=now.getMilliseconds();
                return (h+":"+m+":"+s+ " " +ms);
            }

            var newCount = 1;
            function add(e) {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                        isParent = e.data.isParent,
                        nodes = zTree.getSelectedNodes(),
                        treeNode = nodes[0];
                if (treeNode) {
                    treeNode = zTree.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, isParent:isParent, name:"new node" + (newCount++)});
                } else {
                    treeNode = zTree.addNodes(null, {id:(100 + newCount), pId:0, isParent:isParent, name:"new node" + (newCount++)});
                }
                if (treeNode) {
                    zTree.editName(treeNode[0]);
                } else {
                    alert("叶子节点被锁定，无法增加子节点");
                }
            };
            function edit() {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                        nodes = zTree.getSelectedNodes(),
                        treeNode = nodes[0];
                if (nodes.length == 0) {
                    alert("请先选择一个节点");
                    return;
                }
                zTree.editName(treeNode);
            };
            function remove(e) {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                        nodes = zTree.getSelectedNodes(),
                        treeNode = nodes[0];
                if (nodes.length == 0) {
                    alert("请先选择一个节点");
                    return;
                }
                zTree.removeNode(treeNode);
            };
            function clearChildren(e) {
                var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
                        nodes = zTree.getSelectedNodes(),
                        treeNode = nodes[0];
                if (nodes.length == 0 || !nodes[0].isParent) {
                    alert("请先选择一个父节点");
                    return;
                }
                zTree.removeChildNodes(treeNode);
            }

            function showRMenu(type, x, y) {
                $("#rMenu ul").show();
                $("#rMenu").css({"top":y+"px", "left":x+"px", "visibility":"visible"}); //设置右键菜单的位置、可见
                $("body").bind("mousedown", onBodyMouseDown);
            }
            //隐藏右键菜单
            function hideRMenu() {
                if ($("#rMenu").css({"visibility": "hidden"})); //设置右键菜单不可见
                $("body").unbind("mousedown", onBodyMouseDown);
            }
            //鼠标按下事件
            function onBodyMouseDown(event){
                if (!(event.target.id == "rMenu" || $(event.target).parents("#rMenu").length>0)) {
                    $("#rMenu").css({"visibility" : "hidden"});
                }
            }

            function expand(){
                hideRMenu();
                var selectNodes = zTree.getSelectedNodes();
                zTree.expandNode(selectNodes[0], true, null, null);
            }
//展开所有子节点
            function expandSon(){
                hideRMenu();
                var selectNodes = zTree.getSelectedNodes();
                zTree.expandNode(selectNodes[0], true, true, null);
            }
//折叠子节点
            function collapse(){
                hideRMenu();
                var selectNodes = zTree.getSelectedNodes();

                zTree.expandNode(selectNodes[0], false, null, null);
            }
//全部展开
            function expandAll(){
                hideRMenu();
                zTree.expandAll(true);
            }
//全部折叠
            function collapseAll(){
                hideRMenu();
                zTree.expandAll(false);
            }
            //----------------------------------------

            $(document).ready(function(){
                // $("#addParent").bind("click", {isParent:true}, add);
                $("#addParent").click(function(){
                    $("#dialog-function-update").modal('show');
                });
                //$("#addLeaf").bind("click", {isParent:false}, add);
                $("#addLeaf").click(function () {
                });
                $("#edit").bind("click", edit);
                $("#remove").bind("click", remove);
                $("#clearChildren").bind("click", clearChildren);
            });

            function chaxun() {
                $.get('/pipes/ossmodule/info/query',function (res) {
                    console.log(res);
                    res=JSON.parse(res);
                    var zNodes = res.rows;
                    $.fn.zTree.init($("#treeDemo"), setting, zNodes);


                });
            }
            chaxun();
            //提交新增功能模块
            $("#formbtn-function-update").click(function(){
                var form=$("#form-function-update");
                var json = form.serializeJson();
                var data = {"bean":$.objectToString(json)};
                $.ajax({
                    url:'/pipes/ossmodule/info/update',
                    type:'JSON',
                    data:data,
                    error:function(err){
                        console.log(err);
                    },
                    success:function(res){
                        console.log(res);
                        if (data && data.retcode && data.retcode > 0)
                        {
                            alert(data.retinfo);
                        } else {
                            alert("新增模块成功");
                            $("#dialog-function-update").modal('hide');
                            chaxun();
                        }
                    }
                })
            });
            //提交新增功能操作
            $("#formbtn-operation-update").click(function(){
                var form=$("#form-operation-update");
                var json = form.serializeJson();
                var data = {"bean":$.objectToString(json)};
                $.ajax({
                    url:'/pipes/ossmodule/option/update',
                    type:'JSON',
                    data:data,
                    error:function(err){
                        console.log(err);
                    },
                    success:function(res){
                        console.log(res);
                        if (data && data.retcode && data.retcode > 0)
                        {
                            alert(data.retinfo);
                        } else {
                            alert("新增模块成功");
                            $("#dialog-operation-update").modal('hide');
                            chaxun();
                        }
                    }
                })
            });
            //
            //---------------根据商户名称过滤门店管理员信息---------
            $("#filter_merchid").focus(function(){
                var data2={
                    merchname:$("#filter_merchid").val().trim()
                };
                ajaxFilterMerch(data2);
            });
            $("#filter_merchid").blur(function(){
                $("#filter_merchid_table").hide();
            });
            $("#filter_merchid").keyup(function(){
                var data2={
                    merchname:$("#filter_merchid").val().trim()
                };
                ajaxFilterMerch(data2);
            });
            //过滤商户名称时所用的ajax
            function ajaxFilterMerch(data){
                $.ajax({
                    url:"/pipes/merch/query",
                    data:{"bean":$.objectToString(data)},
                    dataType:"JSON",
                    type:"POST",
                    success:function(res){
                        if (res && res.retcode && res.retcode > 0)
                        {
                            alert(res.retinfo);
                        }else{
                            $("#merchtable").find("table").html("");
                            var arr= res.rows||[];
                            var _html="";
                            var filterhtml="";
                            for(var i=0;i<arr.length;i++){
                                _html+='<tr><td><input type="hidden" value="'+arr[i].merchid+'">'+arr[i].merchname+'</td></tr>'
                            }
                            var filtertable = $("#filter_merchid_table");
                            filtertable.find("table").html(_html);
                            filtertable.find('td').css("width","150px");
                            filtertable.find('td').css("cursor","pointer");
                            filtertable.show();
                            filtertable.find('td').css("padding","10px");
                        }
                    },
                    error:function(err){
                        console.log(err);
                    }
                })
            }
            //过滤商户名称时点击商户名称的table和在输入框直接敲击回车时
            $("#filter_merchid_table").on('mousedown','td',function(){
                $("#filter_merchid").val($(this).text());
                $("#hidden_filter_merchid").val($(this).find('input').val());
                $("#filter_merchid_table").hide();
            });
            $('#filter_merchid').bind('keypress', function (event) {
                if (event.keyCode == 13) {
                    $('#filter_merchid_table').find('table').children(':first').find('td').trigger('click');
                }
            });
            $("#showall").click(function(){
                $("#filter_merchid").val("");
                $("#hidden_filter_merchid").val("");
                $("#filter_merchid_table").hide();
                mtable.api(true).draw(false);
                $('#table-merchUser-sheet').dataTable().fnPageChange(0);
            });
            //---------------------------------------------------
            $.ajax({
                url: "/pipes/merch/query",
                data:{"bean":"{}"},
                dataType:"JSON",
                type:"POST",
                success:function(res){
                    var qjmerchname = res.rows||[];
                    //门店商户名称输入框获得焦点时&&新增门店信息商户名称输入框按键操作时
                },
                error:function(err){
                    console.log(err);
                    alert("请求失败");
                }
            });
            $("#merchid").focus(function(){
                var data = {
                    merchname:$("#merchid").val().trim()
                };
                ajaxMerch(data);
            });
            $("#merchid").blur(function(){
                $("#merchtable").hide();
            });
            $("#merchid").keyup(function(){
                var data = {
                    merchname:$("#merchid").val().trim()
                };
                ajaxMerch(data);
            });
            //新增门店信息时点击商户名称的table和在输入框直接敲击回车时
            $("#merchtable").on('mousedown','td',function(){
                $("#merchid").val($(this).text());
                $("#hiddenmerchid").val($(this).find('input').val());
                $("#merchtable").hide();
            });
            $("#merchid").keydown(function(e){
                if(e.keyCode==13){
                    $('#merchtable').find('table').children(':first').find('td').trigger('click');
                }
            });
            //新增门店信息时获取商户名称所用的ajax
            function ajaxMerch(data){
                $.ajax({
                    url:"/pipes/merch/query",
                    data:{"bean":$.objectToString(data)},
                    dataType:"JSON",
                    type:"POST",
                    success:function(res){
                        if (res && res.retcode && res.retcode > 0)
                        {
                            alert(res.retinfo);
                        }else{
                            $("#merchtable").find("table").html("");
                            var arr= res.rows||[];
                            var _html="";
                            var filterhtml="";
                            for(var i=0;i<arr.length;i++){
                                _html+='<tr><td><input type="hidden" value="'+arr[i].merchid+'">'+arr[i].merchname+'</td></tr>'
                            }
                            $("#merchtable").find("table").html(_html);
                            $("#merchtable").find('td').css("width",$('#merchid').width()+24+"px");
                            $("#merchtable").find('td').css("cursor","pointer");
                            $("#merchtable").show();
                            $("#merchtable").find('td').css("padding","10px");
                        }
                    },
                    error:function(err){
                        console.log(err);
                    }
                })
            }
            $("#form-merchUser-update").find('.form-group').css("marginRight","0");
            if (system_memberinfo && system_memberinfo.memberid) {
                type = function (value, type, full) {
                    if(value=="10"){return '<font>管理员</font>'}
                    if(value=="20"){return '<font>店长</font>'}
                };
                merchInfo = function (value) {
                    if(value){
                        return value.merchname;
                    }else{
                        return "暂无";
                    }

                };
                //----------------------------------------------------
                var mtable = $('#table-merchUser-sheet').dataTable({
                    ajax: {
                        url: "/pipes/merch/merchuser/query",
                        dataSrc:"data",
                        data: function (f) {
                            f.bean = JSON.stringify({
                                type: 10,
                                mobile: $('#filter_mobile').val().trim(),
                                username:$("#filter_merchuser").val().trim(),
                                merchid:$("#hidden_filter_merchid").val(),
                                status: Number($('#filter_storeinfo_status').val().trim())==0?[10,20,40,50,60,70,80]:[Number($('#filter_storeinfo_status').val().trim())]
                            });
                            f.sort = 'createtime';
                            f.order = 'DESC';
//                            f.length = 15;
                        }
                    },
                    "aLengthMenu": [[15, 25, 50, -1], ["15条", "25条", "50条", "All"]],
                    columnDefs: [
                        {
                            className: 'select-checkbox',
                            targets: 0
                        },
                        {
                            targets:7,
                            visible:false
                        }
                    ],
                    columns: [
                        {"data": " ", render: $.defrender},
                        {"data": "merchInfo", render:merchInfo},
                        {"data": "type", render:type},
                        {"data":"username",render:$.defrender},
                        {"data": "account", render: $.defrender},
                        {"data": "status", render: defStatusRender},
                        {"data": "mobile", render: $.defrender},
                        {"data": "password", render: $.defrender},
                        /*  {"data": "remark", render: $.defrender},*/
                        {"data": "createtime", render: Date.DateFormatter}
                    ]
                });
                $('#filter-merchUser-qrybtn').bind("click", function () {
                    $('#table-merchUser-sheet').dataTable().fnPageChange(0);
                    mtable.api(true).draw(false);
                });
            }
            //-------------------------点击新增管理员信息-----------------------------
            $('#button-merchUser-create').bind("click", function () {
                $('#dtitle-merchUser-update').html("新增管理员信息");
                $("#form-merchUser-update").form('reset');
                $('#dialog-merchUser-update').modal('show');
                $("#createmerch").show();
                $('#password').show();
                merchUserValidator();
            });
            //-------------------------点击修改管理员信息-----------------------------------------------------
            $('#button-merchUser-update').bind("click", function () {
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.merchid) {
                    alert("请选择一条记录！");
                    return;
                }
                $('#dtitle-merchUser-update').html("修改管理员信息");
                $("#form-merchUser-update").form('reset');
                $("#form-merchUser-update").form('load', data);
                $("#createmerch").hide();
                $("#password").hide();
                merchUserValidator();
                $('#dialog-merchUser-update').modal('show');

            });
            //-----------------------------重置密码---------------------------------
            $("#button-user-reset").bind("click",function () {
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.merchid) {
                    alert("请选择一条记录！");
                    return;
                }
                if (data.type == system_adminpid) {
                    alert("不允许修改管理员账号");
                    return;
                }
                if (system_memberinfo.type==system_adminpid&&system_adminpid==8192) {
                    $("#dialog-merchUser-update").modal('show');
                    $("#form-merchUser-update").form('load', data);
                    $('#dtitle-user-update').html("重置密码");
                    $("#createmerch").hide();
                    $("#password").show();
                    $("#password").find('input').val("");
                    merchUserValidator();
                }
            });
            //-------------------------点击提交按钮新增管理员记录--------------------------------------------
            $("#formbtn-merchUser-update").on("click",function(){
                $(this).attr("disabled",true);
                var form=$("#form-merchUser-update");
                var json = form.serializeJson();
                if(json.password.length<32){
                    json.password = $.md5(json.password);
                }
                $('#form-merchUser-update').bootstrapValidator('validate');
                if(json.type==10){
                    json.admin=true;
                }
                //-----去json数据中的空格-----------------
                var json1= {};
                $.each(json,function(key,value){
                    value = (value + "").replace(/\s/g,'');
                    json1[key] = value;
                });
                json = json1;
                //---------------------------------
                var data = "";
                if(json.merchuserid){
                    var cols=[];
                    for(var i in json){
                        if(json.password.length>32){
                            if(i!='password'){
                                cols.push(i);
                            }
                        }else{
                            cols.push(i);
                        }
                    }
                    data={
                        "bean": $.objectToString(json),
                        "cols": $.objectToString(cols)
                    }
                }else{
                    data={
                        "bean": $.objectToString(json)
                    }
                }
                if( $('#form-merchUser-update').data('bootstrapValidator').isValid()){
                    $.ajax({
                        cache: false,
                        dataType: "json",
                        type: "POST",
                        url: '/pipes/merch/merchuser/update',
                        data: data,
                        error: function () {//请求失败处理函数
                            $("#formbtn-merchUser-update").removeAttr('disabled');
                            alert('请求失败');
                        },
                        success: function (data) {
                            $("#formbtn-merchUser-update").removeAttr('disabled');
                            if (data && data.retcode && data.retcode > 0)
                            {
                                alert(data.retinfo);
                            } else {
                                alert("保存成功");
                                $('#form-merchUser-update').data('bootstrapValidator').destroy();
                                $('#form-merchUser-update').data('bootstrapValidator', null);
                                $("#dialog-merchUser-update").modal('hide');
                                mtable.api(true).draw(false);
                            }
                        }
                    });
                }else{
                    $("#formbtn-merchUser-update").removeAttr('disabled');
                    alert("验证失败，请按要求填写信息");
                }
            });
            //---------------表单验证----------------------------------------------
            function merchUserValidator(){
                $("#form-merchUser-update").bootstrapValidator({
                    message: 'This value is not valid',
                    feedbackIcons: {/*输入框不同状态，显示图片的样式*/
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields:{
                        account:{
                            message: 'The billno is not valid',
                            validators: {
                                notEmpty: {/*非空提示*/
                                    message: '员工账号不能为空'
                                },
                                regexp: { /* 只需加此键值对 */
                                    regexp: /^[a-zA-Z][\d\w@.]{4,36}$/,
                                    message: '员工帐号必须以字母开头，5位以上长度,不能包含汉字和特殊符号'
                                }
                            }
                        },
                        password:{
                            message: 'The password is not valid',
                            validators: {
                                notEmpty: {
                                    message: '密码不能为空'
                                },
                                regexp: {
                                    regexp:/^\w{6,20}$/,
                                    message: '密码只能由字母数字下划线组成，长度为6-20位'
                                }
                            }
                        },
                        username:{
                            message: 'The username is not valid',
                            validators: {
                                notEmpty: {
                                    message: '员工昵称不能为空'
                                }
                            }
                        },
                        mobile:{
                            message: 'The mobile is not valid',
                            validators:{
                                notEmpty: {
                                    message: '手机号码不能为空'
                                },
                                regexp: {
                                    regexp:/^1\d{10}$/,
                                    message: '请输入正确的手机号码'
                                }
                            }
                        }
                    }
                });
            }
        });
    }
</script>

