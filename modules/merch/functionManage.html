<!--ztree树形栏目-->
<div id="tree">
    &nbsp;[ <a id="addParent" href="#" title="新增功能模块" onclick="return false;">新增功能模块</a> ]
    &nbsp;[ <a id="updateParent" href="#" title="修改功能模块" onclick="return false;">修改功能模块</a> ]
    <ul id="goodsTree" class="ztree" style="min-width: 220px;min-height: 360px;">

    </ul>
</div>
<!--右键菜单-->
<div id="treeMenu" style=" padding:8px; width: 150px;height: 90px; border:solid 1px cadetblue;background: white;position: absolute;color: black;display:none">
    <ul id="treeMenuUl" style="height: 25px; line-height: 25px;font-size: 16px; margin: 0;padding: 0;">
        <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="1">添加</li>
        <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="3">删除</li>
        <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="4">查看</li>
    </ul>
</div>
<div id="optionMenu" style=" padding:8px; width: 150px;height: 90px; border:solid 1px cadetblue;background: white;position: absolute;color: black;display:none">
    <ul id="optionMenuUl" style="height: 25px; line-height: 25px;font-size: 16px; margin: 0;padding: 0;">
        <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="1">添加</li>
        <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="3">删除</li>
        <li style="list-style: none" onmouseover="style='background:#eee5a4;list-style:none'" onmouseleave="style='background:none;list-style:none'" value="4">查看</li>
    </ul>
</div>
<!--模块modal-->
<div id="dialog-function-update" class="modal fade" tabindex="-1" data-width="600" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" id="recordclose">×</button>
        <h4 id="dtitle-function-update" class="modal-title">新增模块</h4>
    </div>
    <div class="modal-body">
        <form id="form-function-update" class="m-t form-horizontal" role="form">
            <input  name="createtime" type="hidden">
            <input name="b2bmoduleinfoid" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="status">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>模块名称</label>
                <div class="col-lg-9"><input name="modulename" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="platform">
                        <option value="B2B">商家版</option>
                        <option value="B2C">顾客版</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>icon图标地址</label>
                <div class="col-lg-9"><input name="icon" class="form-control"></div>
            </div>
            <button id="formbtn-function-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>

<div id="dialog-operation-update" class="modal fade" tabindex="-1" data-width="600" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-operation-update" class="modal-title">新增功能操作</h4>
    </div>
    <div class="modal-body">
        <form id="form-operation-update" class="m-t form-horizontal" role="form">
            <input  name="createtime" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="status">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>所属模块</label>
                <div class="col-lg-9">
                    <input name="moduleid" type="hidden" id="moduleid">
                    <input value="" class="form-control" disabled id="modulename">
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>操作名称</label>
                <div class="col-lg-9"><input name="modulename" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="platform">
                        <option value="B2B">商家版</option>
                        <option value="B2C">顾客版</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>icon图标地址</label>
                <div class="col-lg-9"><input name="icon" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>访问url</label>
                <div class="col-lg-9"><input name="url" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>功能描述</label>
                <div class="col-lg-9"><input name="description" class="form-control"></div>
            </div>
            <button id="formbtn-operation-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>

<script>
    chaxun();
    var node="";
    var optionNode="";
    function chaxun() {
        $.ajax({
            url:"/pipes/ossmodule/info/query",
            data:{},
            type:"POST",
            dataType:"JSON",
            success:function(data){
                debugger;
                console.log(data);
                var zNodes = data.rows;
                $.ajax({
                    url:"/pipes/ossmodule/option/query",
                    data:{},
                    type:"POST",
                    dataType:"JSON",
                    success:function(res){
                        zNodes =  zNodes.concat(res.rows);
                        zTreeInit(settings,zNodes);
                    },
                    error:function (err) {
                        console.log(err);
                    }
                });
            },
            error:function(err){
                console.log(err);
            }
        });
    }
    var settings = {
        data : {
            key:{
                name:"modulename"
            },
            simpleData : {
                enable : true,
                isSimpleData : false, //数据是否采用简单 Array 格式，默认false
                treeNodeKey : "b2bmoduleinfoid", //在isSimpleData格式下，当前节点id属性
                treeNodeParentKey : "tlevelid", //在isSimpleData格式下，当前节点的父节点id属性
                showLine : true, //是否显示节点间的连线
               // checkable : true,
                rootPId : 0,
                idKey:"b2boptioninfoid",
                pIdKey:"b2bmoduleinfoid",
                expandFlag :true
                //不设置rootId，则树栏目的pId则为null
            }
        },
        callback : {
            onRightClick : zTreeOnRightClick,
            beforeClick: zTreeOnclick
        }
    };
    function zTreeInit(settings,zNodes){
        $.fn.zTree.init($("#goodsTree"),settings,zNodes);
        var treeObj = $.fn.zTree.getZTreeObj("goodsTree");
        treeObj.expandAll(true);
        initMenu();
    }
    //右击鼠标事件
    function zTreeOnRightClick(event,treeId,treeNode){
        event.preventDefault();//屏蔽系统右键事件
        console.log(treeNode);
        if(treeNode!=null){
            var _top=event.clientY;
            var _left=event.clientX;
            node=treeNode;
            $("#treeMenu").show().css({top:_top,left:_left});
        }
    }
    //单机鼠标左键事件
    function zTreeOnclick(treeId, treeNode, clickFlag) {
        optionNode = treeNode;
    }
    $("#updateParent").click(function(){
        if(optionNode.b2bmoduleinfoid){
            $("#form-function-update").form('load',optionNode);
            $("#dtitle-function-update").text("修改模块");
            $("#dialog-function-update").modal('show');
        }else{
            alert("请单击你想要修改的功能名称");
        }
    });
    $("#addParent").click(function(){
        $("#dtitle-function-update").text("新增模块");
        $("#dialog-function-update").modal('show');
    });
    //点击其他地方菜单消失
    $(document).click(function(){
        $("#treeMenu").hide();
    });
    //初始化编辑菜单
    function initMenu(){
        var menuUl=$("#treeMenuUl");
        var menuLi=menuUl.find("li");
        for(var v = 0; v<menuLi.length; v++){
            menuLi.eq(v).unbind("click").click(function(){
                menuLiClick(this);
            });
        }
    }
    //判断所选择的编辑项
    function menuLiClick(self){
        console.log(self);
        if(self.value == "1"){
            console.log(node);
            $("#moduleid").val(node.b2bmoduleinfoid);
            $("#modulename").val(node.modulename);
            $("#dialog-operation-update").modal('show');
        }
    }


    //提交新增功能模块
    $("#formbtn-function-update").click(function(){
        var form=$("#form-function-update");
        var json = form.serializeJson();
        var data = "";
        var cols = [];
        if(json.b2bmoduleinfoid){
            for(var i in json){
                cols.push(i);
            }
            data = {
                "bean":$.objectToString(json),
                "cols":$.objectToString(cols)
            };
        }else{
            data = {
                "bean":$.objectToString(json)
            };
        }
        $.ajax({
            url:'/pipes/ossmodule/info/update',
            type:'JSON',
            data:data,
            error:function(err){
                console.log(err);
            },
            success:function(res){
                console.log(res);
                if (data && data.retcode && data.retcode > 0)
                {
                    alert(data.retinfo);
                } else {
                    alert("操作功能模块成功");
                    $("#dialog-function-update").modal('hide');
                    chaxun();
                }
            }
        })
    });

    //提交新增功能操作
    $("#formbtn-operation-update").click(function(){
        var form=$("#form-operation-update");
        var json = form.serializeJson();
        var data = "";
        var cols = [];
        if(json.b2boptioninfoid){
            for(var i in json){
                cols.push(i);
            }
            data = {
                "bean":$.objectToString(json),
                "cols":$.objectToString(cols)
            }
        }else{
            data = {"bean":$.objectToString(json)};
        }
        $.ajax({
            url:'/pipes/ossmodule/option/update',
            type:'JSON',
            data:data,
            error:function(err){
                console.log(err);
            },
            success:function(res){
                console.log(res);
                if (data && data.retcode && data.retcode > 0)
                {
                    alert(data.retinfo);
                } else {
                    alert("功能操作保存成功");
                    $("#dialog-operation-update").modal('hide');
                    chaxun();
                }
            }
        })
    });
    //

</script>