
<div class="form-group">
    <div class="col-lg-3 col-md-3 col-sm-3">
        <div class="page-title">
            &nbsp;<a id="button-module-create" href="#" onclick="return false;">新增模块名称</a>
            &nbsp;<a id="button-module-update" href="#" onclick="return false;">修改模块名称</a>
            <a id="allmodule" href="#" onclick="return false;">显示全部</a>
        </div>
        <div class="panel-box">
            <div class="table-responsive">
                <table id="table-module-sheet" class="table table-hover" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th></th>
                        <th>等级ID</th>
                        <th>moduleId</th>
                        <th>模块名称</th>
                        <th>所属平台</th>
                        <th>创建时间</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-9 col-md-9 col-sm-9">
        <div class="page-title">
            <a id="option_create" href="javascript:void(0);"><i class="fa fa-plus"></i>新增功能操作</a>
            <a id="option_update" href="javascript:void(0);"><i class="fa fa-pencil-square-o"></i>修改功能操作</a>
        </div>
        <div class="panel-box">
           <!-- <div class="page-title">
                <form class="filter-search" onsubmit="return false">
                    <div style="display: inline-block;margin: 0 10px 0 0;">
                        <label >商户名称：</label>
                        <input id="hidden_filter_merchid" type="hidden">
                        <input id="filter_merchid" style="width:150px;position: relative">
                        <div class="table-responsive" id="filter_merchid_table">
                            <table class="table table-hover">
                            </table>
                        </div>
                    </div>
                    <button style="width: 120px;" id="showall">显示全部</button>
                    <i id="filter-merchLevel-qrybtn" class="fa fa-search" style="position: static;"></i>
                </form>
            </div>-->
            <div class="table-responsive">
                <table id="table-option-sheet" class="table table-hover" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th></th>
                        <th>等级ID</th>
                        <th>所属模块id</th>
                        <th>optionid</th>
                        <th>操作名称</th>
                        <th>平台</th>
                        <th>描述</th>
                        <th>图片地址</th>
                        <th>URL</th>
                        <th>创建时间</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="dialog-option-update" class="modal fade" tabindex="-1" data-width="600" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="dtitle-operation-update" class="modal-title">新增功能操作</h4>
    </div>
    <div class="modal-body">
        <form id="form-option-update" class="m-t form-horizontal" role="form">
            <input  name="createtime" type="hidden">
            <input name="b2boptioninfoid" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="status">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>所属模块</label>
                <div class="col-lg-9">
                    <select name="moduleid" id="moduleid" class="form-control">
                    </select>
                  <!--  <input name="moduleid" type="hidden" >
                    <input value="" class="form-control" id="modulename">-->
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>操作名称</label>
                <div class="col-lg-9"><input name="optionname" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="platform">
                        <option value="B2B">商家版</option>
                        <option value="B2C">顾客版</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>icon图标地址</label>
                <div class="col-lg-9"><input name="icon" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>访问url</label>
                <div class="col-lg-9"><input name="url" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>功能描述</label>
                <div class="col-lg-9"><input name="description" class="form-control"></div>
            </div>
            <button id="formbtn-option-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>
<div id="dialog-module-update" class="modal fade" tabindex="-1" data-width="600" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" id="recordclose">×</button>
    </div>
    <div class="modal-body">
        <form id="form-module-update" class="m-t form-horizontal" role="form">
            <input  name="createtime" type="hidden">
            <input name="b2bmoduleinfoid" type="hidden">
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="status">
                        <option value="10">正常</option>
                        <option value="20">待审批</option>
                        <option value="80">删除</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>模块名称</label>
                <div class="col-lg-9"><input name="modulename" class="form-control"></div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>平台</label>
                <div class="col-lg-9">
                    <select class="form-control" name="platform">
                        <option value="B2B">商家版</option>
                        <option value="B2C">顾客版</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>icon图标地址</label>
                <div class="col-lg-9"><input name="icon" class="form-control"></div>
            </div>
            <button id="formbtn-module-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>
<input type="hidden" id="hiddenid">

<script>
    {
        $(function() {
            optionChaXun();
            //--------------------------制定模块区域-----------------------------
            //模块列表
            var moduleTable = $('#table-module-sheet').dataTable({
                ajax: {
                    url: "/pipes/ossmodule/info/query",
                    dataSrc: "data",
                    data: function (f) {
                        f.sort = 'createtime';
                        f.order = 'DESC';
                    }
                },
                info: false,
                paging: false,
                lengthChange: false,
                "aLengthMenu": [[15, 25, 50, -1], ["15条", "25条", "50条", "All"]],
                columnDefs: [
                    {
                        className: 'select-checkbox',
                        targets: 0
                    }
                ],
                columns: [
                    {"data": " ", render: $.defrender},
                    {"data": "tlevelid", render: function(value){
                        if(value==0){
                            return 0;
                        }else{
                            return value;
                        }
                    }},
                    {"data": "b2bmoduleinfoid", render: $.defrender},
                    {"data": "modulename", render: $.defrender},
                    {"data": "platform", render: $.defrender},
                    {"data": "createtime", render: Date.DateFormatter}
                ]
            });

            //-------------------------功能操作区域----------------------------------------
            //获取模块列表option
            function optionChaXun(){
                $.get("/pipes/ossmodule/info/query", function (res) {
                    res = JSON.parse(res);
                    var arr = res.rows;
                    var _html = "";
                    for (var i = 0; i < arr.length; i++) {
                        _html += '<option value="' + arr[i].b2bmoduleinfoid + '">' + arr[i].modulename + '</option>'
                    }
                    $("#moduleid").html(_html);
                });
            }
            $('#button-module-create').bind("click", function () {
                $("#form-module-update").form('reset');
                $('#dialog-module-update').modal('show');
            });
            $('#button-module-update').bind("click", function () {
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.merchid) {
                    alert("请选择一条记录！");
                    return;
                }
                $("#form-module-update").form('reset');
                $("#form-module-update").form('load', data);
                $('#dialog-module-update').modal('show');
            });
            $("#formbtn-module-update").on("click", function () {
                $(this).attr("disabled", true);
                var form = $("#form-module-update");
                var json = form.serializeJson();
                var data = "";
                if (json.tlevelid) {
                    var cols = [];
                    for (var i in json) {
                        if (i == "tlevelid") {
                            continue;
                        } else {
                            cols.push(i);
                        }
                    }
                    data = {
                        "bean": $.objectToString(json),
                        "cols": $.objectToString(cols)
                    }
                } else {
                    data = {
                        "bean": $.objectToString(json)
                    }
                }
                $.ajax({
                    cache: false,
                    dataType: "json",
                    type: "POST",
                    url: '/pipes/ossmodule/info/update',
                    data: data,
                    error: function () {//请求失败处理函数
                        $("#formbtn-module-update").removeAttr('disabled');
                        alert('请求失败');
                    },
                    success: function (data) {
                        $("#formbtn-module-update").removeAttr('disabled');
                        if (data && data.retcode && data.retcode > 0) {
                            alert(data.retinfo);
                        } else {
                            alert("保存成功");
                            $("#dialog-module-update").modal('hide');
                            moduleTable.api(true).draw(false);
                            optionChaXun();
                        }
                    }
                });
            });

            var mtable = $('#table-option-sheet').dataTable({
                ajax: {
                    url: "/pipes/ossmodule/option/query",
                    dataSrc: "data",
                    data: function (f) {
                        f.bean = JSON.stringify({
                            moduleid:$("#hiddenid").val()
                        });
                        f.sort = 'createtime';
                        f.order = 'DESC';
                    }
                },
                "aLengthMenu": [[15, 25, 50, -1], ["15条", "25条", "50条", "All"]],
                columnDefs: [
                    {
                        className: 'select-checkbox',
                        targets: 0
                    }
                ],
                columns: [
                    {"data": " ", render: $.defrender},
                    {"data": "tlevelid", render: $.defrender},
                    {"data": "moduleid", render: $.defrender},
                    {"data": "b2boptioninfoid", render: $.defrender},
                    {"data": "optionname", render: $.defrender},
                    {"data": "platform", render: $.defrender},
                    {"data": "description", render: $.defrender},
                    {"data": "icon", render: $.defrender},
                    {"data": "url", render: $.defrender},
                    {"data": "createtime", render: Date.DateFormatter}
                ]
            });
            //新增功能操作
            $("#option_create").click(function () {
                var optionform = $("#form-option-update");
                optionform.form('reset');
                $("#dialog-option-update").modal('show');
            });
            //修改功能操作
            $("#option_update").click(function () {
                var data = mtable.api(true).row({selected: true}).data();
                console.log(data);
                if (!data || !data.b2boptioninfoid) {
                    alert("请选择一条记录！");
                    return;
                }
                var optionform = $("#form-option-update");
                optionform.form('reset');
                data.price = (data.price / 100).toFixed(2);
                optionform.form('load', data);
                $("#dialog-option-update").modal('show');
            });
            //提交新增模块模块
            $("#formbtn-option-update").click(function () {
                var form = $("#form-option-update");
                var json = form.serializeJson();
                var data = "";
                var cols = [];
                if (!json.createtime) {
                    data = {"bean": $.objectToString(json)};
                } else {
                    for (var i in json) {
                        cols.push(i);
                    }
                    data = {
                        "bean": $.objectToString(json),
                        "cols": $.objectToString(cols)
                    };
                }
                $.ajax({
                    url: '/pipes/ossmodule/option/update',
                    type: 'JSON',
                    data: data,
                    error: function (err) {
                        console.log(err);
                    },
                    success: function (res) {
                        res = JSON.parse(res);
                        if (data && data.retcode && data.retcode > 0) {
                            alert(data.retinfo);
                        } else {
                            alert("操作成功");
                            $("#dialog-option-update").modal('hide');
                            mtable.api(true).draw(false);
                        }
                    }
                })
            });
            //------------------点击列表筛选--------------------------
            //点击标签进行会员的筛选
            $("#table-module-sheet").on('click','td',function(){
                var data = moduleTable.api(true).row({selected: true}).data();
                if(data&&data.b2bmoduleinfoid){
                    $("#hiddenid").val(data.b2bmoduleinfoid);
                }else{
                    $("#hiddenid").val("");
                }
                mtable.api(true).draw(false)
            });
            $("#allmodule").click(function(){
                $("#hiddenid").val("");
                mtable.api(true).draw(false);
            });
        });
        }
</script>
