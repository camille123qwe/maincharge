<div class="page-title">
    <a id="button-picture-create" href="javascript:void(0);"><i class="fa fa-plus"></i>上传banner图片</a>
    <a id="button-picture-update" href="javascript:void(0);"><i class="fa fa-pencil-square-o"></i>修改</a>
    <div style="display: inline-block;margin: 0 30px 0 0;">
        <label >状态</label>
        <select name="status" id="filter_picture_status" style="width:150px;">
            <option value="10,20">正常,待审批</option>
            <option value="10">正常</option>
            <option value="20">待审批</option>
            <option value="80">删除</option>
            <option value="10,20,80">全部</option>
        </select>
    </div>
</div>
<div class="panel-box">
    <div class="table-responsive">
        <table id="table-picture-sheet" class="table table-hover" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th></th>
                <th>排序数字</th>
                <th>banner图ID</th>
                <th class="storename">关联门店</th>
                <th>限时抢购商品</th>
                <th>关联商品</th>
                <th>图片</th>
                <th>状态</th>
                <th>banner图类型</th>
                <th>banner图有效期</th>
                <th>创建时间</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="dialog-picture-update" class="modal fade" tabindex="-1" data-width="800" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" id="recordclose">×</button>
        <h4 id="dtitle-picture-update" class="modal-title">新增banner图</h4>
    </div>
    <div class="modal-body">
        <form id="form-picture-update" class="m-t form-horizontal" role="form">
            <div class="form-group">
                <div class="form-group col-lg-6 col-md-6">
                    <label class="col-lg-12 col-md-12 control-label">显示顺序</label>
                    <div class="col-lg-8 col-md-8">
                        <input class="form-control" type="number" step="1" name="display" id="display" placeholder="显示顺序，值大靠前">
                    </div>
                </div>
                <div class="form-group col-lg-6 col-md-6">
                    <label class="col-lg-12 col-md-12 control-label"><span style="color: red;">*&nbsp;</span>状态</label>
                    <div class="col-lg-8 col-md-8">
                        <select id="selectStatus" name="status" class="form-control">
                            <option value="20">待审批</option>
                            <option value="10">正常</option>
                            <option value="80">删除</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                    <div class="form-group col-lg-6 col-md-6">
                    <label class="col-lg-12 col-md-12 control-label"><span style="color: red;">*&nbsp;</span>banner图类型</label>
                    <div class="col-lg-8 col-md-8">
                        <select id="selectType" name="type" class="form-control">
                            <option value="10">顾客版</option>
                            <option value="20">商家版</option>
                        </select>
                    </div>
                </div>
                <div class="form-group col-lg-6 col-md-6">
                    <label class="col-lg-12 col-md-12 control-label">关联门店</label>
                    <div class="col-lg-8 col-md-8">
                        <input name="relativestoreid" type="hidden" id="relativestoreid">
                        <input class="form-control" id="filter_storeid" style="position: relative" placeholder="无关联门店请填0" autocomplete="off">
                        <div class="table-responsive" id="filter_storeid_table" style="width: 90%;left: 10%;">
                            <table class="table table-hover">
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3"><button type="button" class="form-control button" id="filter_storeid_button" onsubmit="false">搜索</button></div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-group col-lg-6 col-md-6">
                    <label class="col-lg-12 control-label" style="text-align: left">关联限时优惠商品</label>
                    <div class="col-lg-8 col-md-8">
                        <input name="rushid" type="hidden" id="rushid">
                        <input class="form-control" id="filter_rushid" style="position: relative" placeholder="可不填" autocomplete="off">
                        <div class="table-responsive" id="filter_rushid_table" style="width: 90%;left: 10%;">
                            <table class="table table-hover">
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3"><button type="button" class="form-control button" id="filter_rushid_button" onsubmit="false">搜索</button></div>
                </div>
                <div class="form-group col-lg-6 col-md-6">
                    <label class="col-lg-12 col-md-12 control-label" style="text-align: left">关联商品</label>
                    <div class="col-lg-8 col-md-8">
                        <input name="goodsid" type="hidden" id="goodsid">
                        <input class="form-control" id="filter_goodsid" style="position: relative" placeholder="可不填" autocomplete="off">
                        <div class="table-responsive" id="filter_goodsid_table" style="width: 90%;left: 10%;">
                            <table class="table table-hover">
                            </table>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-3 col-sm-3"><button type="button" class="form-control button" id="filter_goodsid_button" onsubmit="false">搜索</button></div>
                </div>
            </div>
            <div class="form-group">
                <div class="form-group col-lg-4 col-md-4">
                    <label class="col-lg-12 col-md-12 control-label" >有效期限(天数)</label>
                    <div class="col-lg-12 col-md-12" ><input name="validday" id="validday" placeholder="为0表示长期有效" class="form-control" ></div>
                </div>
                <div class="form-group col-lg-4 col-md-4">
                    <label class="col-lg-12 col-md-12 control-label" >起始时间</label>
                    <div class="col-lg-12 col-md-12" ><input  name="starttime" id="quanstarttime" placeholder="优惠起始时间" class="form-control"></div>
                </div>
                <div class="form-group col-lg-4 col-md-4">
                    <label class="col-lg-12 col-md-12 control-label" >截止时间</label>
                    <div class="col-lg-12 col-md-12" ><input  name="endtime" readonly id="endtime"  placeholder="优惠结束时间，长期有效则默认为0" class="form-control"></div>
                </div>
            </div>
            <input type="hidden" name="imgsrc" id="imgsrc">
            <input type="hidden" name="createtime" id="createtime">
            <input type="hidden" name="bannerid" id="bannerid">
            <div class="form-group" id="faceimg" >
                <img id="indeximg" class="center-block" src="" style="width:300px;height:180px;border: 1px solid #ddd"/>
            </div>
            <div class="form-group">
                <div class="btn btn-success fileinput-button"
                     id="bannerpic_btn" style="margin:10px 0 10px 40%">
                    <i class="fa fa-fw fa-upload"></i>
                    <span>上传图片<br/>(比例:750*350)</span>
                    <input type="file" name="file" class="green_upload_btn">
                </div>
            </div>
            <div class="form-group" style="text-align: center">
                <p><span style="color: red">*&nbsp;</span>注意:banner图图片大小要在750*350之上</p>
                &nbsp;&nbsp;&nbsp;&nbsp;<span>图片比例为5:3,便于app展示美观</span>
            </div>
            <button id="formbtn-picture-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
</div>
<script>
    (function(){
        $(".control-label").css('textAlign','left');
        $(".form-group").css('marginLeft',0);
        if (system_memberinfo && system_memberinfo.memberid) {
            //---------------选择关联门店---------
            $("#filter_storeid").focus(function(){
                var data={
                    storename:$("#filter_storeid").val().trim()
                };
                ajaxFilterStore(data);
            });
            $("#filter_storeid").blur(function(){
                $("#filter_storeid_table").hide();
            });
            $("#filter_storeid_button").click(function(){
                var data={
                    storename:$("#filter_storeid").val().trim()
                };
                ajaxFilterStore(data);
            });
            //过滤关联门店名称时所用的ajax
            function ajaxFilterStore(data){
                $.ajax({
                    url:"/pipes/store/query",
                    data:{"bean":$.objectToString(data)},
                    dataType:"JSON",
                    type:"POST",
                    success:function(res){
                        if (res && res.retcode && res.retcode > 0)
                        {
                            alert(res.retinfo);
                        }else{
                            // $("#merchtable").find("table").html("");
                            var arr= res.rows||[];
                            var _html="";
                            var filterhtml="";
                            for(var i=0;i<arr.length;i++){
                                _html+='<tr><td><input type="hidden" value="'+arr[i].storeid+'">'+arr[i].storename+'</td></tr>'
                            }
                            var filtertable = $("#filter_storeid_table");
                            filtertable.find("table").html(_html);
                            filtertable.find('td').css("width","150px");
                            filtertable.find('td').css("cursor","pointer");
                            filtertable.show();
                            filtertable.find('td').css("padding","10px");
                        }
                    },
                    error:function(err){
                        console.log(err);
                    }
                })
            }
            //过滤商户名称时点击商户名称的table和在输入框直接敲击回车时
            $("#filter_storeid_table").on('mousedown','td',function(){
                $("#filter_storeid").val($(this).text());
                $("#relativestoreid").val($(this).find('input').val());
                $("#filter_storeid_table").hide();
            });
            $('#filter_storeid').bind('keypress', function (event) {
                if (event.keyCode == 13) {
                    $('#filter_storeid_table').find('table').children(':first').find('td').trigger('click');
                }
            });
            //-----------选择关联限时优惠商品----------------
            $("#filter_rushid").focus(function(){
                var data={
                    goodsname:$("#filter_rushid").val().trim()
                };
                ajaxFilterRush(data);
            });
            $("#filter_rushid").blur(function(){
                $("#filter_rushid_table").hide();
            });
            $("#filter_rushid_button").click(function(){
                var data={
                    goodsname:$("#filter_rushid").val().trim()
                };
                ajaxFilterRush(data);
            });
            //过滤供应商门店名称时所用的ajax
            function ajaxFilterRush(data){
                $.ajax({
                    url:"/pipes/ossrush/querygoodsrushcute",
                    data:{"bean":$.objectToString(data)},
                    dataType:"JSON",
                    type:"POST",
                    success:function(res){
                        if (res && res.retcode && res.retcode > 0)
                        {
                            alert(res.retinfo);
                        }else{
                            // $("#merchtable").find("table").html("");
                            var arr= res||[];
                            var _html="";
                            var filterhtml="";
                            for(var i=0;i<arr.length;i++){
                                _html+='<tr><td><input type="hidden" value="'+arr[i].rushid+'">'+arr[i].goodsname+'</td></tr>'
                            }
                            var filtertable = $("#filter_rushid_table");
                            filtertable.find("table").html(_html);
                            filtertable.find('td').css("width","150px");
                            filtertable.find('td').css("cursor","pointer");
                            filtertable.show();
                            filtertable.find('td').css("padding","10px");
                        }
                    },
                    error:function(err){
                        console.log(err);
                    }
                })
            }
            //过滤商户名称时点击商户名称的table和在输入框直接敲击回车时
            $("#filter_rushid_table").on('mousedown','td',function(){
                $("#filter_rushid").val($(this).text());
                $("#rushid").val($(this).find('input').val());
                $("#filter_rushid_table").hide();
            });
            $('#filter_rushid').bind('keypress', function (event) {
                if (event.keyCode == 13) {
                    $('#filter_rushid_table').find('table').children(':first').find('td').trigger('click');
                }
            });
            //-----------选择关联商品-------------
            $("#filter_goodsid").focus(function(){
                var data={
                    goodsname:$("#filter_goodsid").val().trim()
                };
                ajaxFilterGoods(data);
            });
            $("#filter_goodsid").blur(function(){
                $("#filter_goodsid_table").hide();
            });
            $("#filter_goodsid_button").click(function(){
                var data={
                    goodsname:$("#filter_goodsid").val().trim()
                };
                ajaxFilterGoods(data);
            });
            //过滤供应商门店名称时所用的ajax
            function ajaxFilterGoods(data){
                $.ajax({
                    url:"/pipes/ossgoods/query",
                    data:{"bean":$.objectToString(data)},
                    dataType:"JSON",
                    type:"POST",
                    success:function(res){
                        if (res && res.retcode && res.retcode > 0)
                        {
                            alert(res.retinfo);
                        }else{
                            var arr= res.rows||[];
                            var _html="";
                            var filterhtml="";
                            for(var i=0;i<arr.length;i++){
                                _html+='<tr><td><input type="hidden" value="'+arr[i].goodsid+'">'+arr[i].goodsname+'</td></tr>'
                            }
                            var filtertable = $("#filter_goodsid_table");
                            filtertable.find("table").html(_html);
                            filtertable.find('td').css("width","150px");
                            filtertable.find('td').css("cursor","pointer");
                            filtertable.show();
                            filtertable.find('td').css("padding","10px");
                        }
                    },
                    error:function(err){
                        console.log(err);
                    }
                })
            }
            //过滤商户名称时点击商户名称的table和在输入框直接敲击回车时
            $("#filter_goodsid_table").on('mousedown','td',function(){
                $("#filter_goodsid").val($(this).text());
                $("#goodsid").val($(this).find('input').val());
                $("#filter_goodsid_table").hide();
            });
            $('#filter_goodsid').bind('keypress', function (event) {
                if (event.keyCode == 13) {
                    $('#filter_goodsid_table').find('table').children(':first').find('td').trigger('click');
                }
            });





            //-------新增引导页------------------
            $("#button-picture-create").click(function () {
                $("#formbtn-picture-update").removeAttr("disabled");
                $("#createtime").val("");
                $("#bannerid").val("");
                $("#imgsrc").val("");
                $("#dtitle-picture-update").text("新增banner图");
                $("#dialog-picture-update").modal("show");
                $("#indeximg").attr("src", "");
            });
            //------修改banner页------------------
            $("#button-picture-update").click(function(){
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.bannerid){
                    alert("请选择一条记录！");
                    return;
                }
                $("#dtitle-picture-update").text("修改banner图");
                $("#indeximg").attr("src","/dir/custbanner/"+data.imgsrc);
                data.starttime = time(data.starttime);
                if(data.endtime==0){
                    data.endtime = 0
                }else{
                    data.endtime = time(data.endtime);
                }
                $("#form-picture-update").form('reset');
                $("#form-picture-update").form('load', data);
                if(data.storeName){
                    $("#filter_storeid").val(data.storeName);
                }
                $("#dialog-picture-update").modal('show');

            });
            //------上传banner图片
            $('#bannerpic_btn').fileupload({
                type: 'POST',
                url: '/pipes/upload/custbanner',
                formData: {},
                done: function (e, data) {//设置文件上传完毕事件的回调函数
                    var json = JSON.parse(data.result);
                    var imghtml = '<img id="indeximg" src="/dir/custbanner/' + json.fileid + '" style="width:300px;height:180px;margin-left:30%;border: 1px solid #ddd"/>'
                    $("#faceimg").html(imghtml);
                    $("#imgsrc").val(json.fileid);
                }
            });
            //----------------提交按钮--------------
            $("#formbtn-picture-update").click(function () {
                $(this).attr("disabled","disabled");
                var form = $("#form-picture-update");
                var json = form.serializeJson();
                if (json.imgsrc == "") {
                    alert("请上传图片");
                    $("#formbtn-picture-update").removeAttr("disabled");
                    return;
                }
                var storenameStr = $("#filter_storeid").val().trim();
                var goodsnameStr = $("#filter_rushid").val().trim();
                if(storenameStr==""||storenameStr==0){
                    json.relativestoreid = 0;
                }
                if(goodsnameStr == ""||goodsnameStr==0){
                    json.rushid = 0;
                }
                json.starttime = datetime(json.starttime);
                if (json.endtime == 0) {
                    json.endtime = 0;
                } else {
                    json.endtime = datetime(json.endtime);
                    json.endtime = json.endtime + 24 * 60 * 60 * 1000 - 1;
                }
                var data = "";
                if(json.bannerid){
                    var cols=[];
                    for(var key in json){
                        if(key=="bannerid"){
                            continue
                        }
                        cols.push(key);
                    }
                    data =  {
                        "bean": $.objectToString(json),
                        "cols":  $.objectToString(cols)
                    };
                }else{
                    data =  {
                        "bean": $.objectToString(json)
                    };
                }
                $.ajax({
                    url: "/pipes/appbanner/updatebanner",
                    data: data,
                    type: "POST",
                    error: function (err) {
                        console.log(err);
                        $("#formbtn-picture-update").removeAttr("disabled");
                    },
                    success: function (res) {
                        $("#formbtn-picture-update").removeAttr("disabled");
                        res = JSON.parse(res);
                        if (res.retcode == 0) {
                            alert("保存成功");
                            $("#dialog-picture-update").modal("hide");
                            mtable.api(true).draw(false);
                        }
                    }
                })

            });
            var mtable = $('#table-picture-sheet').dataTable({
                ajax: {
                    url: "/pipes/appbanner/querybanner",//请求后台数据接口
                    data: function (f) {
                        f.bean = JSON.stringify({
                            status: $('#filter_picture_status').val().trim().split(",")
                        });
                        f.sort = 'createtime';
                        f.order = 'DESC';
                    }
                },
                "aLengthMenu": [[10, 25, 50, -1], ["10条", "25条", "50条", "All"]],
                columnDefs: [{
                    className: 'select-checkbox',
                    targets: 0
                }],
                columns: [
                    {"data": "", render: $.defrender},//data对应的是key
                    {"data": "display", render:$.defrender},
                    {"data": "bannerid", render:$.defrender},
                    {"data": "relativestoreid", render:function(value,type,full){
                        var result = "";
                        if(value==0){
                            result = "无";
                        }else{
                          result = full.storeName;
                        }
                        return result;
                    }},
                    {"data": "rushid", render:function(value,type,full){
                        var result = "";
                        if(value==0){
                            result = "无";
                        }else{
                            result = full.rushName;
                        }
                        return result;
                    }},
                    {"data": "goodsid", render:function(value,type,full){
                        var result = "";
                        if(value==0){
                            result = "无";
                        }else{
                            result = full.goodsName;
                        }
                        return result;
                    }},
                    {"data": "imgsrc", render:function (value) {
                        return "<img src=/dir/custbanner/"+value+" style='width:100px;height:60px'>";
                    }},
                    {"data": "status", render: defStatusRender},
                    {"data": "type", render: function(value){
                        if(value==10){
                            return "顾客版banner图";
                        }else if(value==20){
                            return "商家版banner图"
                        }else{
                            return "未知";
                        }
                    }},
                    {"data": "validday", render: function(value,type,full){
                        if(value==0){
                            return "长期有效";
                        }else{
                            return "有效期"+time(full.starttime)+"至"+time(full.endtime);
                        }
                    }},
                    {"data": "createtime", render: Date.DateFormatter}
                ]
            });
            //--------更改状态----------------------------
            $("#filter_picture_status").change(function () {
                mtable.api(true).draw(false);
                $('#table-picture-sheet').dataTable().fnPageChange(0);
            });
            $("#validday").on('change', function () {
                endvalue();
            });
            //-------有效日期的选择
            timeChange();
            function timeChange() {
                var t = new Date().toJSON();
                var t1 = new Date();
                var t2 = new Date(t1);
                t2.setDate(t1.getFullYear() + 5);
                t2 = t2.toJSON();
                $("#quanstarttime").datetimepicker({
                    format: "yyyy-mm-dd", //设置时间格式，默认值: 'mm/dd/yyyy'
                    weekStart: 0, //一周从哪一天开始。0（星期日）到6（星期六）,默认值0
                    startDate: new Date(), //可以被选择的最早时间
                    endDate: new Date(t2), //可以被选择的最晚时间
                    daysOfWeekDisabled: "", //禁止选择一星期中的某些天，例子中这样是禁止选择周六和周日
                    autoclose: true, //当选择一个日期之后是否立即关闭此日期时间选择器
                    startView: 2, //点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
                    minView: 2, //插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
                    maxView: 4, //同理
                    todayBtn: true, //是否在底部显示“今天”按钮
                    todayHighlight: true, //是否高亮当前时间
                    keyboardNavigation: true, //是否允许键盘选择时间
                    language: 'zh-CN', //选择语言，前提是该语言已导入
                    forceParse: true, //当选择器关闭的时候，是否强制解析输入框中的值。也就是说，当用户在输入框中输入了不正确的日期，选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中
                    minuteStep: 5, //分钟的间隔
                    pickerPosition: "top-left", //显示的位置，还支持bottom-left
                    viewSelect: 2, //默认和minView相同
                    showMeridian: true, //是否加上网格
                    initialDate: new Date(t),//初始化的时间
                    zIndex: 1080
                }).on('changeDate', function () {
                    endvalue();
                });
                $("#validday").on('change', function () {
                    endvalue();
                });
                function endvalue() {
                    if ($("#validday").val() == 0) {
                        $("#endtime").val("0");
                    } else {
                        var v = $("#validday").val()-1;
                        var t = $("#quanstarttime").val();
                        t = datetime(t);
                        var t2 = new Date(t);
                        var t2 = t2.setDate(t2.getDate() + Number(v));
                        var year = new Date(t2).getFullYear();
                        var month = new Date(t2).getMonth() + 1;
                        var date = new Date(t2).getDate();
                        if (month < 10) {
                            month = "0" + month;
                        }
                        if (date < 10) {
                            date = "0" + date;
                        }
                        var result = year + "-" + month + "-" + date;
                        $("#endtime").val(result);
                    }
                }
            }
            function time(date) {
                var year = new Date(date).getFullYear();
                var month = new Date(date).getMonth() + 1;
                var date1 = new Date(date).getDate();
                if (month < 10) {
                    month = "0" + month;
                }
                if (date1 < 10) {
                    date1 = "0" + date1;
                }
                var result = year + "-" + month + "-" + date1;
                return result;
            }
            function endvalue() {
                if ($("#validday").val() == 0) {
                    $("#endtime").val("0");
                } else {
                    var v = $("#validday").val()-1;
                    var t = $("#quanstarttime").val();
                    t = datetime(t);
                    var t2 = new Date(t);
                    var t2 = t2.setDate(t2.getDate() + Number(v));
                    var year = new Date(t2).getFullYear();
                    var month = new Date(t2).getMonth() + 1;
                    var date = new Date(t2).getDate();
                    if (month < 10) {
                        month = "0" + month;
                    }
                    if (date < 10) {
                        date = "0" + date;
                    }
                    var result = year + "-" + month + "-" + date;
                    $("#endtime").val(result);
                }
            }
            //将日历中取出的值转换成后台所需的格式
            function datetime(time) {
                time1 = time.replace(/-/g, "/");
                time2 = new Date(time1).getTime();
                return time2;
            }
        }
    })();

</script>


