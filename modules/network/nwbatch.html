<div class="panel-box">    
    <div class="page-title">
        <form class="filter-search" >            
            <div style="display: inline-block;margin: 0 30px 0 0;">
                <label>供货商&nbsp;</label>
                <select id="filter_nwsupplierid" style="width:100px;" name="nwsupplierid" >
                    <option value="0">--全部--</option>
                </select>
            </div>  
            <div style="display: inline-block;margin: 0 30px 0 0;">
                <label>运营商&nbsp;</label>
                <select id="filter_mobnet" style="width:80px;" name="mobnet" >
                    <option value="0">--全部--</option>
                    <option value="2">移动</option>
                    <option value="4">联通</option>
                    <option value="8">电信</option>
                </select>
            </div>   
            <div style="display: inline-block;margin: 0 30px 0 0;">
                <label>初始套餐&nbsp;</label>
                <select id="filter_initnwpkgid" style="width:100px;" name="initnwpkgid" >
                    <option value="0">--全部--</option>
                </select>
            </div>   
            <div style="display: inline-block;margin: 0 30px 0 0;">
                <label>批次号&nbsp;</label>
                <input id="filter_nwbatchid" name="nwbatchid" style="width:100px;"  type="text" placeholder="批次号" >
            </div>
            <div style="display: inline-block;margin: 0 20px 0 0;">
                <label>批次时间&nbsp;</label>
                <input id="filter_starttime" style="width:100px;"  type="text"> 至 <input id="filter_endtime" style="width:100px;" type="text">
            </div>
            <div style="display: inline-block;margin: 0 30px 0 0;">
                <button type="button" id="filter-nwcard-qrybtn" style='padding:2px 10px;'  class="btn btn-primary" >&nbsp;&nbsp;&nbsp;查询&nbsp;&nbsp;&nbsp;</button>
            </div>
        </form>
    </div>
    <div class="table-responsive">
        <table id="table-nwcard-sheet" class="table table-hover" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th></th>
                    <th>批次号</th>
                    <th>供货商</th>             
                    <th>运营商</th>   
                    <th>代理商</th>     
                    <th>卡数量</th>
                    <th>初始套餐</th>
                    <th>出售价</th>
                    <th>创建时间</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="dialog-nwcard-update" class="modal fade" tabindex="-1" data-width="1000" data-backdrop="static" data-keyboard="false" style="display: none;">
    <div class="modal-header"> 
        <button type="button" class="close" data-dismiss="modal" id="nwcardclose" aria-hidden="true">×</button>
        <h4 id="dtitle-nwcard-update" class="modal-title">修改代理商</h4> 
    </div>
    <div class="modal-body" style="background: #fdf8e4">
        <form id="form-nwcard-update" class="m-t form-horizontal" role="form">            
            <input id="form_nwbatchid" name="nwbatchid" type="hidden">
            <ul class="list-group">
                <li class="list-group-item"><span class=" panel panel-primary">代理商信息</span>
                    <div class="form-group">
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>代理商名称</label>
                            <div class="col-lg-8"><input id="nwcardname" name="username" placeholder="代理商名称" class="form-control" maxlength="32"  required  data-error="代理商名称不能为空"><div class="help-block with-errors"></div></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>登录账号</label>
                            <div class="col-lg-8"><input id="nwaccount" name="account" placeholder="登录账号" class="form-control" maxlength="32"  required  data-error="代理商账号不能为空"><div class="help-block with-errors"></div></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>初始密码</label>
                            <div class="col-lg-8"><input id="nwpassword" name="password" placeholder="初始密码" class="form-control" maxlength="64"  required  data-error="初始密码不能为空"><div class="help-block with-errors"></div></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>状态</label>
                            <div class="col-lg-8">
                                <select id="selectCorpStatus" name="status" class="form-control">
                                    <option value="10">正常</option>
                                    <option value="20">待审批</option>
                                    <option value="40">冻结</option>
                                    <option value="50">隐藏</option>
                                    <option value="60">关闭</option>
                                    <option value="70">过期</option>
                                    <option value="80">删除</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label">备注说明</label>
                            <div class="col-lg-8"><input name="remark" placeholder="备注说明" class="form-control"></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label">所在地址</label>
                            <div class="col-lg-8"><input name="address" placeholder="所在地址" class="form-control"></div>
                        </div>
                    </div>
                </li>
            </ul>

            <ul class="list-group">
                <li class="list-group-item"><span class=" panel panel-info">代理商联系人信息</span>
                    <div class="form-group">
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>联系人</label>
                            <div class="col-lg-8"><input name="linkman" placeholder="联系人" required  data-error="请输入正确的联系人" class="form-control"></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label"><span style="color: red;">*&nbsp;</span>联系电话</label>
                            <div class="col-lg-8"><input name="linktel" type="tel" placeholder="联系电话" class="form-control" pattern="^\d{8,13}$" data-error="请输入正确的联系电话"><div class="help-block with-errors"></div></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label">联系微信</label>
                            <div class="col-lg-8"><input name="linkwx" placeholder="联系微信" class="form-control"></div>
                        </div>
                        <div class="col-lg-6">
                            <label class="col-lg-3 control-label">联系QQ</label>
                            <div class="col-lg-8"><input name="linkqq" type="tel" placeholder="联系QQ" class="form-control" pattern="^[1-9]\d{4,12}$" data-error="请输入正确的QQ号码"><div class="help-block with-errors"></div></div>
                        </div>
                    </div>
                </li>
            </ul>
            <br>
            <button id="formbtn-nwcard-update" type="button" class="btn btn-theme btn-lg btn-block ">提 交</button><br>
        </form>
    </div>
    <div id="tips-nwcard-update" class="module-alert-tips"></div><br>
</div>
<script>
    $("#filter_starttime,#filter_endtime").datetimepicker({
        format: "yyyy-mm-dd", //设置时间格式，默认值: 'mm/dd/yyyy'
        weekStart: 0, //一周从哪一天开始。0（星期日）到6（星期六）,默认值0
        startDate: "2016-11-14", //可以被选择的最早时间
        endDate: "2026-02-14", //可以被选择的最晚时间
        daysOfWeekDisabled: "", //禁止选择一星期中的某些天，例子中这样是禁止选择周六和周日
        autoclose: true, //当选择一个日期之后是否立即关闭此日期时间选择器
        startView: 2, //点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
        minView: 2, //插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
        maxView: 4, //同理
        todayBtn: true, //是否在底部显示“今天”按钮
        todayHighlight: true, //是否高亮当前时间
        keyboardNavigation: true, //是否允许键盘选择时间
        language: 'zh-CN', //选择语言，前提是该语言已导入
        forceParse: true, //当选择器关闭的时候，是否强制解析输入框中的值。也就是说，当用户在输入框中输入了不正确的日期，选择器将会尽量解析输入的值，并将解析后的正确值按照给定的格式format设置到输入框中
        minuteStep: 5, //分钟的间隔
        pickerPosition: "bottom-right", //显示的位置，还支持bottom-left
        viewSelect: 2, //默认和minView相同
        showMeridian: true //是否加上网格
    });

    var createQueryBean = function () {
        var starttime = $.strtodate($("#filter_starttime").val());
        var endtime = $.strtodate($("#filter_endtime").val());
        if(endtime) endtime += 24*60*60*1000-1;
        if(starttime && !endtime) endtime = new Date(3000,1,1).getTime();
        var json = {
            "createtime" : starttime ? {min : starttime, max : endtime} : null,
            "nwsupplierid": $("#filter_nwsupplierid").val(),
            "initnwpkgid": $("#filter_initnwpkgid").val(),
            "nwbatchid": $('#filter_nwbatchid').val().trim().replace(/\s/g, ""),
            "sellnwagencyid": 0,
            "mobnet": $('#filter_mobnet').val()
        };
        return json;
    };

    init();
    function init() {
        var nwsuppliers = {};
        global_nwsuppliers = window['global_nwsuppliers'] || [];
        for (var i = 0; i < global_nwsuppliers.length; i++) {
            nwsuppliers['' + global_nwsuppliers[i].nwsupplierid] = global_nwsuppliers[i].nwsuppliername;
            $("<option value=\"" + global_nwsuppliers[i]["nwsupplierid"] + "\">" + global_nwsuppliers[i]["nwsuppliername"] + "</option>").appendTo($("#filter_nwsupplierid"));
        }
        var nwpackages = {};
        global_nwpackages = window['global_nwpackages'] || [];
        for (var i = 0; i < global_nwpackages.length; i++) {
            nwpackages['' + global_nwpackages[i].nwpackageid] = global_nwpackages[i].nwpackagename;
            $("<option value=\"" + global_nwpackages[i]["nwpackageid"] + "\">" + global_nwpackages[i]["nwpackagename"] + "</option>").appendTo($("#filter_initnwpkgid"));
        }
        var topnwagencys = {};
        global_topnwagencys = window['global_topnwagencys'] || [];
        for (var i = 0; i < global_topnwagencys.length; i++) {
            topnwagencys['' + global_topnwagencys[i].nwagencyid] = global_topnwagencys[i].username;
        }
        if (system_memberinfo && system_memberinfo.memberid) {
            var mtable = $('#table-nwcard-sheet').dataTable({
                ajax: {
                    url: "/pipes/network/nwbatch/query",
                    data: function (f) {
                        f.bean = JSON.stringify(createQueryBean());
                        f.sort = 'createtime';
                        f.order = 'DESC';
                    }
                },
                iDisplayLength: 15,
                aLengthMenu: [15],
                columnDefs: [{
                        className: 'select-checkbox',
                        targets: 0
                    }],
                columns: [
                    {"data": "", render: $.defrender},
                    {"data": "nwbatchid", render: $.defrender},
                    {"data": "nwsuppliername", render: $.defrender},
                    {"data": "mobnet", render: function (value, type, full) {
                            if (value == 2) return "移动";
                            if (value == 4) return "联通";
                            if (value == 8) return "电信";
                            return "未知";
                        }},
                    {"data": "buynwagencyname", render: $.defrender},
                    {"data": "cards", render: $.defrender},
                    {"data": "initnwpkgid", render: function (value, type, full) {
                            return nwpackages[value] || "未知";
                        }},
                    {"data": "initbuyprice", render: function (value, type, full) {
                            return ((value || 0) / 100.0).fmoney(2);
                        }},
                    {"data": "createtime", render: Date.DateFormatter}
                ]
            });
            $('#filter-nwcard-qrybtn').unbind("click").bind("click", function () {
                $('#table-nwcard-sheet').dataTable().fnPageChange(0);
            });
            //--------------------------- 初始化新增修改代理商 -----------------------------
            $('#button-nwcard-create').bind("click", function () {
                $('#form-gfield-password').show();
                $('#dtitle-nwcard-update').html("新增代理商");
                $("#tips-nwcard-update").html('');
                $("#form-nwcard-update").form('reset');
                $('#dialog-nwcard-update').modal('show');
                $("#nwaccount").removeAttr("readonly", "readonly");
                $("#nwpassword").removeAttr("readonly", "readonly");
                $("#nwpassword").val("");
                $("#form_nwbatchid").val("0");
                /*    $("#form-nwcard-update").data('bootstrapValidator').destroy();
                 $('#form-nwcard-update').data('bootstrapValidator', null);*/
                nwcardValidator();
            });
            $('#button-nwcard-update').bind("click", function () {
                var data = mtable.api(true).row({selected: true}).data();
                if (!data || !data.nwbatchid) {
                    alert("请选择一条记录！");
                    return;
                }
                /*  $('#form-gfield-password').hide();*/
                $('#dtitle-nwcard-update').html("修改代理商");
                $("#tips-nwcard-update").html('');
                $("#form-nwcard-update").form('reset');
                $("#form-nwcard-update").form('load', data);
                $('#dialog-nwcard-update').modal('show');
                $("#nwaccount").attr("readonly", "readonly");
                $("#nwpassword").val("******");
                $("#nwpassword").attr("readonly", "readonly");
                nwcardValidator();
            });
            //------------------------ 新增&修改代理商提交 -----------------------------
            $('#formbtn-nwcard-update').bind("click", function (e) {
                var form = $("#form-nwcard-update");
                var json = form.serializeJson();
                $('#form-nwcard-update').bootstrapValidator('validate');
                if ($('#form-nwcard-update').data('bootstrapValidator').isValid()) {
                    if (!json.nwbatchid || json.nwbatchid == '0') {
                        json.password = $.md5(json.password);
                    }
                    $.ajax({
                        cache: false,
                        dataType: "json",
                        type: "POST",
                        url: '/pipes/network/nwcard/update',
                        data: {
                            "bean": $.objectToString(json),
                            "columns": JSON.stringify(['username', 'linkman', 'linktel', 'linkqq', 'linkwx', 'status', 'address', 'remark'])
                        },
                        error: function () {//请求失败处理函数
                            alert('请求失败');
                        },
                        success: function (data) {
                            if (data && data.retcode && data.retcode > 0) {
                                alert(data.retinfo);
                            } else {
                                alert("保存成功");
                                $("#form-nwcard-update").data('bootstrapValidator').destroy();
                                $('#form-nwcard-update').data('bootstrapValidator', null);
                                $("#dialog-nwcard-update").modal('hide');
                                mtable.api(true).draw(false);
                            }
                        }
                    });
                } else {
                    alert("验证不通过,请按要求填写信息");
                }
            });
            //-----------------点击关闭摧毁验证---------------------------
            $("#nwcardclose").on("click", function () {
                $("#form-nwcard-update").data('bootstrapValidator').destroy();
                $('#form-nwcard-update').data('bootstrapValidator', null);
            });
            //-----------------验证代理商表单方法------------------------------
            function nwcardValidator() {
                $('#form-nwcard-update').bootstrapValidator({
                    message: 'This value is not valid',
                    feedbackIcons: {
                        /*输入框不同状态，显示图片的样式*/
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        /*验证*/
                        username: {
                            /*键名和input name值对应*/
                            message: 'The username is not valid',
                            validators: {
                                notEmpty: {
                                    /*非空提示*/
                                    message: '代理商名称不能为空'
                                },
                                regexp: {
                                    /* 只需加此键值对 */
                                    regexp: /^[A-Za-z0-9\u4e00-\u9fa5]+$/,
                                    message: '代理商名称不能包含任何数字或者符号'
                                }
                            }
                        }
                    }
                });
            }
        }
    }
</script>
